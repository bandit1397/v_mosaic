import cv2
import os

# =============================
# íŒŒì¼ ì„¤ì •
# =============================
INPUT_VIDEO = "input.mp4"
OUTPUT_VIDEO = "output_mosaic.mp4"

video_path = OUTPUT_VIDEO if os.path.exists(OUTPUT_VIDEO) else INPUT_VIDEO
print("ì‘ì—… ê¸°ì¤€ ì˜ìƒ:", video_path)

cap = cv2.VideoCapture(video_path)
fps = cap.get(cv2.CAP_PROP_FPS) or 30

origin_frames = []
processed_frames = []

while True:
    ret, frame = cap.read()
    if not ret:
        break
    origin_frames.append(frame.copy())
    processed_frames.append(frame.copy())

cap.release()

total_frames = len(origin_frames)
current_idx = 0
paused = True
drawing = False

# tracker êµ¬ì¡°:
# {"roi": (x,y,w,h), "start": frame_idx, "end": frame_idx or None}
trackers = []

start_x, start_y = 0, 0

WINDOW = "STICKY ROI MOSAIC EDITOR"
TRACKBAR = "FRAME"
cv2.namedWindow(WINDOW, cv2.WINDOW_NORMAL)

# =============================
# ëª¨ìì´í¬ í•¨ìˆ˜
# =============================
def apply_mosaic(frame, roi):
    x, y, w, h = map(int, roi)
    if w <= 0 or h <= 0:
        return frame
    sub = frame[y:y+h, x:x+w]
    if sub.size == 0:
        return frame
    small = cv2.resize(sub, (max(1, w//10), max(1, h//10)))
    mosaic = cv2.resize(small, (w, h), interpolation=cv2.INTER_NEAREST)
    frame[y:y+h, x:x+w] = mosaic
    return frame


def redraw_all():
    for f in range(total_frames):
        processed_frames[f] = origin_frames[f].copy()
        for t in trackers:
            if t["start"] <= f and (t["end"] is None or f <= t["end"]):
                processed_frames[f] = apply_mosaic(processed_frames[f], t["roi"])


# =============================
# íŠ¸ë™ë°” ì½œë°±
# =============================
def on_trackbar(pos):
    global current_idx, paused
    paused = True
    current_idx = pos


cv2.createTrackbar(TRACKBAR, WINDOW, 0, total_frames - 1, on_trackbar)

# =============================
# ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
# =============================
def mouse_callback(event, x, y, flags, param):
    global start_x, start_y, drawing

    if paused and event == cv2.EVENT_LBUTTONDOWN:
        drawing = True
        start_x, start_y = x, y

    elif paused and event == cv2.EVENT_LBUTTONUP and drawing:
        drawing = False
        rx = min(start_x, x)
        ry = min(start_y, y)
        rw = abs(x - start_x)
        rh = abs(y - start_y)

        if rw > 10 and rh > 10:
            trackers.append({
                "roi": (rx, ry, rw, rh),
                "start": current_idx,
                "end": None
            })
            redraw_all()

    elif paused and event == cv2.EVENT_RBUTTONDOWN:
        for i in reversed(range(len(trackers))):
            rx, ry, rw, rh = trackers[i]["roi"]
            if rx <= x <= rx+rw and ry <= y <= ry+rh:
                trackers.pop(i)
                redraw_all()
                break


cv2.setMouseCallback(WINDOW, mouse_callback)

# =============================
# ë©”ì¸ ë£¨í”„
# =============================
while True:
    frame = processed_frames[current_idx].copy()

    if paused:
        for t in trackers:
            if t["start"] <= current_idx and (t["end"] is None or current_idx <= t["end"]):
                x, y, w, h = t["roi"]
                cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)

    cv2.imshow(WINDOW, frame)
    cv2.setTrackbarPos(TRACKBAR, WINDOW, current_idx)

    key = cv2.waitKey(int(1000 / fps)) & 0xFF

    if key == ord('q'):
        # ğŸ”’ ì¢…ë£Œ ì‹œì  = í˜„ì¬ í”„ë ˆì„
        for t in trackers:
            if t["end"] is None:
                t["end"] = current_idx
        redraw_all()
        break

    elif key == ord('a'):
        paused = not paused
        print("PAUSE" if paused else "PLAY")

    elif key == ord('s'):
        # ğŸ”’ í˜„ì¬ í”„ë ˆì„ì—ì„œ ëª¨ë“  ì—´ë¦° ROI ì¢…ë£Œ
        for t in trackers:
            if t["end"] is None:
                t["end"] = current_idx
        redraw_all()
        print(f"ROI ì¢…ë£Œ ê³ ì • í”„ë ˆì„: {current_idx}")

    if not paused:
        current_idx += 1
        if current_idx >= total_frames:
            break

cv2.destroyAllWindows()

# =============================
# ê²°ê³¼ ì˜ìƒ ì €ì¥
# =============================
# =============================
# ê²°ê³¼ ì˜ìƒ ì €ì¥
# =============================
if total_frames > 0:

    # ğŸ”’ ì €ì¥ ì‹œì  ê¸°ì¤€ ROI ê°•ì œ ì¢…ë£Œ (ì´ì¤‘ ì•ˆì „)
    for t in trackers:
        if t["end"] is None:
            t["end"] = current_idx

    redraw_all()

    h, w, _ = processed_frames[0].shape
    fourcc = cv2.VideoWriter_fourcc(*"mp4v")
    out = cv2.VideoWriter(OUTPUT_VIDEO, fourcc, fps, (w, h))

    for f in processed_frames:
        out.write(f)

    out.release()
    print("âœ… ì €ì¥ ì‹œì  ì´í›„ í”„ë ˆì„ì— ëª¨ìì´í¬ ì—†ìŒ:", OUTPUT_VIDEO)


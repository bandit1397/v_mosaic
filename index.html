<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í˜„ì¥ìš© ì–¼êµ´ ëª¨ìì´í¬ (PC / GitHub Pages)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:system-ui,-apple-system,"Segoe UI";
  text-align:center;
}
header{
  background:#000;
  padding:12px;
  font-size:18px;
  font-weight:700;
}
#controls{
  margin:10px;
}
input,button{
  font-size:16px;
  padding:6px 12px;
  margin:4px;
}
#wrap{
  position:relative;
  display:inline-block;
}
video{
  display:none; /* ì‹¤ì œ í™”ë©´ì€ canvasë§Œ ì‚¬ìš© */
}
canvas{
  background:#000;
}
#status{
  font-size:14px;
  margin-top:6px;
  color:#ffcc00;
}
.stop{
  color:#ff5555;
  font-weight:bold;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
</head>

<body>

<header>í˜„ì¥ ë¹„ì‹ë³„í™” ì–¼êµ´ ëª¨ìì´í¬</header>

<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <button id="resetBtn">ì¬ì§€ì •</button>
</div>

<div id="status">â€» ì–¼êµ´ì´ ê²¹ì¹˜ë©´ ìë™ ì¤‘ë‹¨</div>

<div id="wrap">
  <canvas id="canvas"></canvas>
</div>

<script>
const video = document.createElement("video");
video.muted = true;
video.playsInline = true;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const resetBtn = document.getElementById("resetBtn");

let trackingEnabled = true;

/* MediaPipe */
const faceDetection = new FaceDetection.FaceDetection({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
});

faceDetection.setOptions({
  model: "short",
  minDetectionConfidence: 0.6
});

faceDetection.onResults(onResults);

/* ì˜ìƒ ì„ íƒ */
document.getElementById("videoInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  video.src = URL.createObjectURL(file);

  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    video.play();
    requestAnimationFrame(processFrame);
  };
});

/* í”„ë ˆì„ ë£¨í”„ */
async function processFrame(){
  if (video.paused || video.ended) return;
  await faceDetection.send({ image: video });
  requestAnimationFrame(processFrame);
}

/* ê²°ê³¼ ì²˜ë¦¬ */
function onResults(results){
  /* ğŸ”‘ í•µì‹¬: ì›ë³¸ í”„ë ˆì„ ë¨¼ì € ê·¸ë¦¬ê¸° */
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (!trackingEnabled) return;
  if (!results.detections) return;

  if (results.detections.length > 1 && facesOverlap(results.detections)){
    trackingEnabled = false;
    statusEl.innerHTML =
      "<span class='stop'>ì–¼êµ´ ê²¹ì¹¨ ê°ì§€ â†’ ì¶”ì  ì¤‘ë‹¨</span>";
    return;
  }

  results.detections.forEach(det => {
    const box = det.locationData.relativeBoundingBox;
    const x = box.xMin * canvas.width;
    const y = box.yMin * canvas.height;
    const w = box.width * canvas.width;
    const h = box.height * canvas.height;
    applyMosaic(x,y,w,h);
  });
}

/* ëª¨ìì´í¬ */
function applyMosaic(x,y,w,h){
  const size = 14;
  ctx.drawImage(canvas, x,y,w,h, x,y,size,size);
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(canvas, x,y,size,size, x,y,w,h);
  ctx.imageSmoothingEnabled = true;
}

/* ê²¹ì¹¨ íŒì • */
function facesOverlap(d){
  const a = d[0].locationData.relativeBoundingBox;
  const b = d[1].locationData.relativeBoundingBox;
  return !(
    a.xMin + a.width < b.xMin ||
    b.xMin + b.width < a.xMin ||
    a.yMin + a.height < b.yMin ||
    b.yMin + b.height < a.yMin
  );
}

/* ì¬ì§€ì • */
resetBtn.onclick = () => {
  trackingEnabled = true;
  statusEl.textContent = "â€» ì–¼êµ´ì´ ê²¹ì¹˜ë©´ ìë™ ì¤‘ë‹¨";
};
</script>

</body>
</html>
